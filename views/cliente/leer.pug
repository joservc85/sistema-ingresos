//- views/cliente/leer.pug

extends ../layout/index

block contenido
    div(class="py-10")
        //- Títulos
        h1(class="text-4xl my-10 font-extrabold text-center text-gray-800")
            | Sistema 
            span(class="font-normal") Ingresos
        h2(class="text-center text-2xl font-bold text-fuchsia-600")= pagina

        //- Contenedor principal
        div(class="mt-8 mx-auto max-w-7xl px-4")
            //- Botón "Nuevo Cliente"
            div(class="flex justify-start mb-6")
                a(href="/cliente/crear" class="flex items-center gap-2 bg-gradient-to-r from-fuchsia-500 to-purple-600 hover:from-fuchsia-600 hover:to-purple-700 text-white font-bold py-2 px-4 rounded-md transition-all")
                    i(class="fas fa-plus")
                    span Nuevo Cliente

            //- --- ¡NUEVO! Formulario de Búsqueda ---
            form(method="GET" action="/cliente/leer" class="bg-slate-50 border border-slate-200 p-4 rounded-lg shadow-sm mb-8")
                div(class="flex flex-col md:flex-row gap-4 items-end")
                    div(class="flex-grow w-full")
                        label(for="busqueda" class="block text-sm font-medium text-gray-700 mb-1") Buscar Cliente
                        input(type="text" name="busqueda" id="busqueda" placeholder="Nombre, Apellido, Email o Instagram..." value=busqueda || '' class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-fuchsia-500 focus:border-fuchsia-500")
                    
                    div(class="flex items-center gap-2 w-full md:w-auto")
                        button(type="submit" class="w-full md:w-auto flex items-center justify-center gap-2 bg-fuchsia-600 hover:bg-fuchsia-700 text-white font-bold px-4 py-2 rounded-lg transition")
                            i(class="fas fa-search")
                            span Buscar
                        a(href="/cliente/leer" class="w-full md:w-auto flex items-center justify-center gap-2 bg-gray-400 hover:bg-gray-500 text-white font-bold px-4 py-2 rounded-lg transition")
                            i(class="fas fa-undo")
                            span Limpiar

            //- Mensaje para cuando no hay clientes
            if !clientes.length
                div(class="text-center py-10")
                    p(class="text-xl text-gray-600") No se encontraron clientes con esos criterios.
            else
                //- Contenedor de las tarjetas de clientes
                div(class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6") 
                    each cliente in clientes
                        //- Tarjeta individual de cliente
                        div(class="bg-white rounded-xl shadow-md overflow-hidden transition-transform duration-300 hover:-translate-y-1")
                            div(class="p-6")
                                //- Nombre y Apellidos
                                div(class="mb-4")
                                    p(class="text-lg font-bold text-fuchsia-700")= `${cliente.nombre} ${cliente.apellidos}`
                                    p(class="text-sm text-gray-500")= cliente.tipo || 'Cliente'

                                //- Datos de contacto con iconos
                                div(class="space-y-3 text-sm")
                                    div(class="flex items-center gap-2")
                                        i(class="fas fa-id-card text-gray-400 w-4")
                                        if cliente.cedula
                                            span(class="text-gray-700")= cliente.cedula
                                        else
                                            span(class="text-gray-500 italic") No registrada
                                    div(class="flex items-center gap-2")
                                        i(class="fas fa-phone-alt text-gray-400 w-4")
                                        span(class="text-gray-700")= cliente.telefono
                                    div(class="flex items-center gap-2")
                                        i(class="fas fa-envelope text-gray-400 w-4")
                                        if cliente.email
                                            a(href=`mailto:${cliente.email}` class="text-sky-600 hover:underline truncate")= cliente.email
                                        else
                                            span(class="text-gray-500 italic") No registrado
                                    
                                    //- --- ¡NUEVO! Campo de Instagram ---
                                    div(class="flex items-center gap-2")
                                        i(class="fab fa-instagram text-gray-400 w-4")
                                        if cliente.instagram
                                            a(href=`https://instagram.com/${cliente.instagram.replace('@', '')}` target="_blank" class="text-sky-600 hover:underline")= cliente.instagram
                                        else
                                            span(class="text-gray-500 italic") No registrado

                                //- Estado y Acciones
                                div(class="mt-6 pt-4 border-t border-gray-200 flex justify-between items-center")
                                    //- Insignia de Estado (Activo/Inactivo)
                                    span(class=`${cliente.activo ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'} text-xs font-medium px-2.5 py-1 rounded-full`)= cliente.activo ? 'Activo' : 'Inactivo' 
                                    
                                    //- Botones de acción
                                    - const hasPermission = usuario && usuario.role && (usuario.role.nombre === 'Admin' || usuario.role.nombre === 'Supervisor')
                                    div(class="flex items-center space-x-2")
                                        a(href=hasPermission ? `/cliente/editar/${cliente.id}` : '#' title="Editar" class=`flex items-center justify-center h-8 w-8 rounded-full bg-blue-100 text-blue-600 ${hasPermission ? 'hover:bg-blue-200' : 'opacity-50 cursor-not-allowed'}`)
                                            i(class="fas fa-pencil-alt text-sm")
                                        
                                        form(method="POST", action=hasPermission ? `/cliente/eliminar/${cliente.id}` : '#', class="form-eliminar")
                                            input(type="hidden", name="_csrf", value=csrfToken)
                                            button(type=hasPermission ? "submit" : "button" disabled=!hasPermission title=hasPermission ? "Eliminar" : "No tienes permiso" class=`flex items-center justify-center h-8 w-8 rounded-full bg-red-100 text-red-600 ${hasPermission ? 'hover:bg-red-200 cursor-pointer' : 'opacity-50 cursor-not-allowed'}`)
                                                i(class="fas fa-trash-alt text-sm")
                
                //- Paginación (si hay más de una página)
                if totalPaginas > 1 
                    div(class="mt-8")
                        include ../layout/paginacion

//- Bloque de scripts
block scripts
    //- Tu script genérico de alertas y confirmación de eliminación
    script(src="/js/gestionAlertas.js")