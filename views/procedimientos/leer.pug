//- views/procedimientos/leer.pug

extends ../layout/index

block contenido
    div(class="py-10")
        //- Títulos originales, se mantienen en esta vista
        h1(class="text-4xl my-10 font-extrabold text-center text-gray-800")
            | Sistema 
            span(class="font-normal") Ingresos
        h2(class="text-center text-2xl font-bold text-fuchsia-600")= pagina

        //- Contenedor principal
        div(class="mt-8 mx-auto max-w-7xl px-4")
            //- Botón "Nuevo Procedimiento" adaptado
            div(class="flex flex-col sm:flex-row justify-start items-center gap-4 mb-6")
                a(href="/procedimientos/crear" class="flex items-center gap-2 bg-gradient-to-r from-fuchsia-500 to-purple-600 hover:from-fuchsia-600 hover:to-purple-700 text-white font-bold py-2 px-4 rounded-md transition-all")
                    i(class="fas fa-plus")
                    span Nuevo Procedimiento
                a(href="/precios/nuevo" class="w-full sm:w-auto flex items-center gap-2 bg-gradient-to-r from-green-500 to-teal-600 hover:from-green-600 hover:to-teal-700 text-white font-bold py-2 px-4 rounded-md transition-all")
                    i(class="fas fa-dollar-sign")
                    span Registrar Precio

            //- Contenedor de las tarjetas de procedimientos
            if procedimientos.length
                div(class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6") 
                    each procedimiento in procedimientos
                        //- Tarjeta individual de procedimiento
                        div(class="bg-white rounded-xl shadow-md overflow-hidden transition-transform duration-300 hover:-translate-y-1")
                            div(class="p-6")
                                //- Nombre del Procedimiento
                                div(class="mb-4")
                                    p(class="text-lg font-bold text-fuchsia-700 truncate" title=procedimiento.nombre)= procedimiento.nombre
                                    p(class="text-sm text-gray-500") Procedimiento Registrado

                                //- Dato del Precio con icono
                                div(class="space-y-3 text-sm")
                                    div(class="flex items-center gap-2")
                                        i(class="fas fa-dollar-sign text-gray-400 w-4")
                                        //- Se comprueba si el procedimiento tiene un precio asociado para evitar errores
                                        span(class="text-gray-700 font-semibold")= procedimiento.precio ? `$ ${parseFloat(procedimiento.precio.monto).toLocaleString('es-CO')}` : 'Sin Precio Asignado'
                                
                                //- Estado y Acciones
                                //- Contenedor de Estado y Acciones (Versión final y limpia)
                                div(class="mt-6 pt-4 border-t border-gray-200 flex justify-between items-center")
                                    
                                    //- Estado (Activo/Inactivo)
                                    //- NOTA: Cambia 'procedimiento.activo' por 'cliente.activo' en la vista de clientes
                                    span(class=`${procedimiento.activo ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'} text-xs font-medium px-2.5 py-1 rounded-full`)= procedimiento.activo ? 'Activo' : 'Inactivo'

                                    //- Contenedor para los botones de acción
                                    div(class="flex items-center space-x-2")
                                        - const isAdmin = usuario && usuario.role && (usuario.role.nombre === 'Admin' || usuario.role.nombre === 'Supervisor')
                                        
                                        //- Botón Editar
                                        a(
                                            href=isAdmin ? `/procedimientos/editar/${procedimiento.id}` : '#'
                                            title="Editar"
                                            class=`flex items-center justify-center h-8 w-8 rounded-full bg-blue-100 text-blue-600 ${isAdmin ? 'hover:bg-blue-200' : 'opacity-50 cursor-not-allowed'}`
                                        )
                                            i(class="fas fa-pencil-alt text-sm")
                                        
                                        //- Botón Eliminar
                                        form(
                                            method="POST"
                                            action=isAdmin ? `/procedimientos/eliminar/${procedimiento.id}` : '#'
                                            class="form-eliminar"
                                        )
                                            input(type="hidden", name="_csrf", value=csrfToken)
                                            button(
                                                type=isAdmin ? "submit" : "button"
                                                title=isAdmin ? "Eliminar" : "No tienes permiso"
                                                disabled=!isAdmin
                                                class=`flex items-center justify-center h-8 w-8 rounded-full bg-red-100 text-red-600 ${isAdmin ? 'hover:bg-red-200 cursor-pointer' : 'opacity-50 cursor-not-allowed'}`
                                            )
                                                i(class="fas fa-trash-alt text-sm")
            else
                p(class="text-center text-gray-600 py-10") No hay Procedimientos registrados.
                                
            //- Paginación (funciona sin cambios gracias al controlador)
            if totalPaginas > 1
                div(class="mt-8")
                    include ../layout/paginacion

//- Bloque de scripts adaptado para "procedimiento"
block scripts
    if query.guardado
        script.
            Swal.fire({ icon: 'success', title: '¡Registro exitoso!', text: 'El procedimiento fue registrado correctamente.', confirmButtonColor: '#a21caf' });
            if (window.history.replaceState) { const url = new URL(window.location); url.searchParams.delete('guardado'); window.history.replaceState({}, document.title, url.pathname); }
    if query.actualizado
        script.
            Swal.fire({ icon: 'success', title: '¡Actualización exitosa!', text: 'Los datos del procedimiento fueron actualizados.', confirmButtonColor: '#a21caf' });
            if (window.history.replaceState) { const url = new URL(window.location); url.searchParams.delete('actualizado'); window.history.replaceState({}, document.title, url.pathname); }
    if query.eliminado
        script.
            Swal.fire({ icon: 'success', title: '¡Eliminado!', text: 'El procedimiento ha sido eliminado correctamente.', confirmButtonColor: '#a21caf' });
            if (window.history.replaceState) { const url = new URL(window.location); url.searchParams.delete('eliminado'); window.history.replaceState({}, document.title, url.pathname); }
    
    //- El script para la confirmación de eliminación es reutilizable y no necesita cambios.
    script.
        document.addEventListener('DOMContentLoaded', () => {
            const formularios = document.querySelectorAll('.form-eliminar');
            formularios.forEach(form => {
                form.addEventListener('submit', function (e) {
                    e.preventDefault(); 
                    Swal.fire({
                        title: '¿Estás seguro?', text: 'Esta acción no se puede deshacer', icon: 'warning',
                        showCancelButton: true, confirmButtonColor: '#d33', cancelButtonColor: '#3085d6',
                        confirmButtonText: 'Sí, eliminar', cancelButtonText: 'Cancelar'
                    }).then((result) => { if (result.isConfirmed) { form.submit(); } });
                });
            });
        });