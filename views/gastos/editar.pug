extends ../layout/index

block contenido
    .py-10
        h1(class="text-4xl my-10 font-extrabold text-center text-gray-800")
            | Sistema&nbsp;
            span(class="font-normal") Gastos
        h2(class="text-center text-2xl font-bold text-fuchsia-600")= pagina

        div(class="mx-auto max-w-4xl")
            //- Botón de regresar, ahora dentro del contenedor
            div(class="flex justify-start mb-4")
                a(href="/gastos" class="flex items-center gap-2 text-gray-600 hover:text-gray-800 transition-colors")
                    i(class="fas fa-arrow-left")
                    span(class="font-bold") Regresar

            div(class="bg-white shadow-lg rounded-lg mx-auto max-w-4xl p-6 md:p-8")

                //- Muestra de errores de validación
                if errores
                    div(class="mb-6")
                        each error in errores
                            div(class="flex items-center bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-2" role="alert")
                                svg(class="w-6 h-6 text-red-600 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor")
                                    path(stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z")
                                p(class="font-bold")= error.msg

                form(method="POST" action=`/gastos/editar/${gasto.id}`)
                    input(type="hidden" name="_csrf" value=csrfToken)

                    //- SECCIÓN DE CABECERA (Sin cambios)
                    fieldset.border.border-gray-300.p-4.rounded-md
                        legend.px-2.text-lg.font-semibold.text-gray-700 Datos Generales
                        div(class="grid grid-cols-1 md:grid-cols-2 gap-6")
                            //- Proveedor
                            div
                                label(for="proveedorId" class="block text-sm font-medium text-gray-700") Proveedor
                                select#proveedorId(name="proveedorId" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-fuchsia-500 focus:border-fuchsia-500 sm:text-sm")
                                    option(value="") -- Seleccione un Proveedor --
                                    each proveedor in proveedores
                                        option(value=proveedor.id selected=gasto.proveedorId == proveedor.id ? true : false) #{proveedor.razon_social}
                            
                            //- Fecha del Gasto
                            div
                                label(for="fecha_gasto" class="block text-sm font-medium text-gray-700") Fecha del Gasto
                                - const fechaFormateada = gasto.fecha_gasto ? new Date(gasto.fecha_gasto).toISOString().split('T')[0] : ''
                                input#fecha_gasto(type="date" name="fecha_gasto" value=fechaFormateada class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-fuchsia-500 focus:border-fuchsia-500 sm:text-sm")

                            //- Número de Factura
                            div(class="md:col-span-1")
                                label(for="numero_factura" class="block text-sm font-medium text-gray-700") Número Factura/Recibo
                                input#numero_factura(type="text" name="numero_factura" placeholder="Ej: F-001-12345" value=gasto.numero_factura class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-fuchsia-500 focus:border-fuchsia-500 sm:text-sm")

                            //- Descripción
                            div(class="md:col-span-2")
                                label(for="descripcion" class="block text-sm font-medium text-gray-700") Descripción General (Opcional)
                                textarea#descripcion(name="descripcion" rows="2" placeholder="Ej: Compra de insumos para manicura" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-fuchsia-500 focus:border-fuchsia-500 sm:text-sm")= gasto.descripcion

                    //- SECCIÓN DE DETALLE DEL GASTO (MODIFICADA)
                    fieldset.mt-6.border.border-gray-300.p-4.rounded-md
                        legend.px-2.text-lg.font-semibold.text-gray-700 Detalle del Gasto
                        
                        div#detalle-gastos-container.space-y-4
                            //- Iteramos sobre los detalles existentes
                            each detalle in gasto.gastos_adicionales_detalles
                                div.detalle-item.grid.grid-cols-12.gap-x-3.items-center.p-2.border.rounded-md.bg-gray-50
                                    //- Artículo (Buscador)
                                    div(class="col-span-12 md:col-span-5")
                                        label.text-xs.text-gray-600 Artículo / Concepto
                                        input(type="text" name="articulo_nombre" value=detalle.articulo.nombre_articulo placeholder="Buscar artículo..." class="w-full text-sm border-gray-300 rounded-md")
                                        input(type="hidden" name="articuloId[]" value=detalle.articuloId)
                                    
                                    //- Cantidad
                                    div(class="col-span-4 md:col-span-2")
                                        label.text-xs.text-gray-600 Cantidad
                                        input(type="number" name="cantidad[]" value=detalle.cantidad min="0.01" step="0.01" class="w-full text-sm border-gray-300 rounded-md" oninput="calcularSubtotal(this.closest('.detalle-item'))")
                                    
                                    //- Precio Unitario (MODIFICADO)
                                    div(class="col-span-4 md:col-span-2")
                                        label.text-xs.text-gray-600 Precio Unit.
                                        //- Input VISIBLE para el usuario
                                        input(type="text" placeholder="0" class="w-full text-sm border-gray-300 rounded-md px-2 text-right precio-visible" oninput="actualizarValor(event)" value=formatearMoneda(detalle.precio_unitario))
                                        //- Input OCULTO que se envía al servidor
                                        input(type="hidden" name="precio_unitario[]" class="precio-oculto" value=detalle.precio_unitario)

                                    //- Subtotal
                                    div(class="col-span-4 md:col-span-2 text-center md:text-right")
                                        label.text-xs.text-gray-600 Subtotal
                                        p.detalle-subtotal.font-bold.text-gray-800.mt-2 $0
                                    
                                    //- Botón Eliminar
                                    div(class="col-span-12 md:col-span-1 flex justify-end md:justify-center items-center")
                                        button(type="button" class="eliminar-detalle text-red-500 hover:text-red-700 p-2")
                                            i(class="fas fa-trash-alt fa-lg")
                        
                        button(type="button" id="agregar-detalle" class="mt-4 flex items-center gap-2 bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-colors cursor-pointer")
                            i(class="fas fa-plus")
                            span Añadir Artículo

                    //- SECCIÓN DE TOTALES Y GUARDADO
                    div.mt-8.pt-5.border-t.border-gray-200
                        div(class="flex justify-end items-center gap-x-6")
                            div(class="text-right")
                                p(class="text-gray-500") Total General del Gasto:
                                p#total-general(class="text-3xl font-extrabold text-gray-800") $0
                            
                            button(type="submit" class="bg-fuchsia-600 hover:bg-fuchsia-700 text-white font-bold py-3 px-8 rounded-lg shadow-md transition-colors text-lg cursor-pointer") Guardar Cambios

        //- PLANTILLA PARA UNA FILA DE DETALLE (MODIFICADA)
        div#plantilla-detalle.hidden
            div(class="detalle-item grid grid-cols-12 gap-x-3 items-center p-2 border rounded-md bg-gray-50")
                //- Artículo
                div(class="col-span-12 md:col-span-5")
                    label(class="text-xs text-gray-600") Artículo / Concepto
                    input(type="text" name="articulo_nombre" placeholder="Buscar artículo..." class="w-full text-sm border-gray-300 rounded-md")
                    input(type="hidden" name="articuloId[]")
                
                //- Cantidad
                div(class="col-span-4 md:col-span-2")
                    label(class="text-xs text-gray-600") Cantidad
                    input(type="number" name="cantidad[]" value="1" min="0.01" step="0.01" class="w-full text-sm border-gray-300 rounded-md" oninput="calcularSubtotal(this.closest('.detalle-item'))")
                
                //- Precio Unitario
                div(class="col-span-4 md:col-span-2")
                    label(class="text-xs text-gray-600") Precio Unit.
                    input(type="text" placeholder="0" class="w-full text-sm border-gray-300 rounded-md px-2 text-right precio-visible" oninput="actualizarValor(event)")
                    input(type="hidden" name="precio_unitario[]" class="precio-oculto" value="0")

                //- Subtotal
                div(class="col-span-4 md:col-span-2 text-center md:text-right")
                    label(class="text-xs text-gray-600") Subtotal
                    p(class="detalle-subtotal font-bold text-gray-800 mt-2") $0
                
                //- Botón Eliminar
                div(class="col-span-12 md:col-span-1 flex justify-end md:justify-center items-center")
                    button(type="button" class="eliminar-detalle text-red-500 hover:text-red-700 p-2 cursor-pointer")
                        i(class="fas fa-trash-alt fa-lg")

block scripts
    //- Script para inicializar los cálculos al cargar la página
    script.
        document.addEventListener('DOMContentLoaded', function() {
            // Seleccionamos todas las filas de detalle que no sean la plantilla
            const filasExistentes = document.querySelectorAll('#detalle-gastos-container .detalle-item');
            filasExistentes.forEach(fila => {
                calcularSubtotal(fila);
            });
        });

    //- Carga la librería de TomSelect y LUEGO nuestro script personalizado.
    script(src="/js/formGasto.js")