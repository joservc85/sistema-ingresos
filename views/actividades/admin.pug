extends ../layout/index

block contenido
    div(class="py-10")
        //- Títulos
        h1(class="text-4xl my-10 font-extrabold text-center text-gray-800")
            | Sistema 
            span(class="font-normal") Ingresos
        h2(class="text-center text-2xl font-bold text-fuchsia-600")= pagina

        //- Contenedor principal
        div(class="mt-8 mx-auto max-w-7xl px-4")

            //- Barra de Acciones y Filtros
            div(class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-8")
                //- Botones de Acción
                div(class="flex flex-wrap gap-2")
                    a(href="/actividades/crear" class="flex-grow md:flex-grow-0 flex items-center justify-center gap-2 bg-gradient-to-r from-fuchsia-500 to-purple-600 text-white font-bold py-2 px-4 rounded-lg")
                        i(class="fas fa-plus")
                        span Asignar Actividad
                    if usuario && usuario.role && (usuario.role.nombre === 'Admin' || usuario.role.nombre === 'Supervisor')
                        a(href="/actividades/pagos" class="flex-grow md:flex-grow-0 flex items-center justify-center gap-2 bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-lg")
                            i(class="fas fa-chart-line")
                            span Reporte de Pagos
                        a(href="/cierre-caja/historial" class="flex-grow md:flex-grow-0 flex items-center justify-center gap-2 bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg")
                            i(class="fas fa-archive")
                            span Historial de Cierres
            
            //- Panel de Búsqueda y Filtros
            div(class="bg-slate-50 border border-slate-200 p-4 rounded-lg shadow-sm")
                form(method="GET", action="/mis-actividades")
                    div(class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4")
                        //- Filtros Desplegables
                        div
                            label(for="personalId" class="block text-sm font-medium text-gray-700 mb-1") Personal
                            select(name="personalId" id="personalId" class="w-full px-3 py-2 border border-gray-300 rounded-lg")
                                option(value="") Todos
                                each persona in personales
                                    option(value=persona.id selected=(query.personalId == persona.id))= `${persona.nombre} ${persona.apellidos}`
                        div
                            label(for="clienteId" class="block text-sm font-medium text-gray-700 mb-1") Cliente
                            select(name="clienteId" id="clienteId" class="w-full px-3 py-2 border border-gray-300 rounded-lg")
                                option(value="") Todos
                                each cliente in clientes
                                    option(value=cliente.id selected=(query.clienteId == cliente.id))= `${cliente.nombre} ${cliente.apellidos}`
                        div
                            label(for="procedimientoId" class="block text-sm font-medium text-gray-700 mb-1") Procedimiento
                            select(name="procedimientoId" id="procedimientoId" class="w-full px-3 py-2 border border-gray-300 rounded-lg")
                                option(value="") Todos
                                each procedimiento in procedimientos
                                    option(value=procedimiento.id selected=(query.procedimientoId == procedimiento.id))= procedimiento.nombre
                        
                        //- Búsqueda por Nombre
                        div
                            label(for="buscar" class="block text-sm font-medium text-gray-700 mb-1") Buscar por nombre
                            input(type="text" name="buscar" id="buscar" placeholder="Cliente, Personal..." value=(query.buscar || '') class="w-full px-3 py-2 border border-gray-300 rounded-lg")

                        //- Filtros de Fecha
                        div
                            label(for="fechaInicio" class="block text-sm font-medium text-gray-700 mb-1") Desde
                            input(type="date" name="fechaInicio" id="fechaInicio" value=(query.fechaInicio || '') class="w-full px-3 py-2 border border-gray-300 rounded-lg")
                        div
                            label(for="fechaFin" class="block text-sm font-medium text-gray-700 mb-1") Hasta
                            input(type="date" name="fechaFin" id="fechaFin" value=(query.fechaFin || '') class="w-full px-3 py-2 border border-gray-300 rounded-lg")
                        
                        //- Botones de Acción
                        div(class="lg:col-span-2 flex items-end gap-3")
                            button(type="submit" class="w-full flex items-center justify-center gap-2 bg-fuchsia-600 hover:bg-fuchsia-700 text-white font-bold px-4 py-2 rounded-lg cursor-pointer")
                                i(class="fas fa-search")
                                span Buscar
                            a(href="/mis-actividades" class="w-full flex items-center justify-center gap-2 bg-gray-400 hover:bg-gray-500 text-white font-bold px-4 py-2 rounded-lg")
                                i(class="fas fa-undo")
                                span Limpiar

            //- Contenedor de las fichas
            if !fichas.length
                div(class="text-center py-10 bg-white rounded-lg shadow")
                    p(class="text-xl text-gray-600") No hay actividades que coincidan con tu búsqueda.
            else
                div(class="space-y-8")
                    each ficha in fichas
                        div(class="bg-white rounded-xl shadow-lg overflow-hidden")
                            //- Cabecera de la tarjeta
                            div(class="bg-slate-50 p-4 border-b border-slate-200 flex flex-col sm:flex-row justify-between sm:items-center gap-2")
                                div(class="flex items-center gap-3")
                                    i(class="fas fa-calendar-day text-fuchsia-600 text-xl")
                                    p(class="text-lg font-bold text-gray-800")= ficha.fecha
                                div(class="flex items-center gap-3")
                                    i(class="fas fa-user-nurse text-fuchsia-600 text-xl")
                                    p(class="text-lg font-semibold text-gray-700")= ficha.personal
                            
                            //- Contenido de la tarjeta
                            div(class="p-4 md:p-6")
                                //- Tabla de Actividades Responsiva
                                if ficha.actividades.length
                                    h4(class="text-fuchsia-800 font-bold text-lg mb-2") Actividades del Día
                                    div(class="overflow-x-auto")
                                        table(class="w-full text-sm text-left")
                                            thead(class="hidden md:table-header-group bg-slate-100 text-slate-600 uppercase")
                                                tr
                                                    th(class="px-4 py-2") Cliente
                                                    th(class="px-4 py-2") Procedimiento
                                                    th(class="px-4 py-2 text-right") Precio
                                                    th(class="px-4 py-2 text-center") Acciones
                                            tbody
                                                each actividad in ficha.actividades
                                                    tr(class=`block md:table-row mb-4 md:mb-0 border md:border-none rounded-lg shadow-md md:shadow-none ${actividad.estado === 'Anulada' ? 'bg-red-50 text-gray-500' : ''}`)
                                                        td(class="block md:table-cell p-3 text-right md:text-left border-b md:border-b-0")
                                                            span(class="md:hidden float-left font-bold") Cliente:
                                                            | #{actividad.cliente ? `${actividad.cliente.nombre} ${actividad.cliente.apellidos}` : ''}
                                                        td(class="block md:table-cell p-3 text-right md:text-left border-b md:border-b-0")
                                                            span(class="md:hidden float-left font-bold") Procedimiento:
                                                            if actividad.estado === 'Anulada'
                                                                span(class="px-2 py-1 text-xs font-semibold text-red-700 bg-red-100 rounded-full mr-2") Anulada
                                                            | #{actividad.procedimiento ? actividad.procedimiento.nombre : ''}
                                                        td(class="block md:table-cell p-3 text-right border-b md:border-b-0")
                                                            span(class="md:hidden float-left font-bold") Precio:
                                                            | #{actividad.precio ? `$ ${parseFloat(actividad.precio.monto).toLocaleString('es-CO')}` : ''}
                                                        td(class="block md:table-cell p-3")
                                                            div(class="flex items-center justify-end md:justify-center space-x-4")
                                                                if actividad.detalle_actividads && actividad.detalle_actividads.length > 0
                                                                    button(type="button" class="ver-detalles-btn text-blue-500 hover:text-blue-700 text-lg cursor-pointer" title="Ver Materiales" data-detalles=JSON.stringify(actividad.detalle_actividads))
                                                                        i(class="fas fa-eye")
                                                                if actividad.procedimiento
                                                                    button(type="button" class="generar-factura-btn text-green-500 hover:text-green-700 text-lg cursor-pointer" title="Imprimir Carta" data-actividad-id=actividad.id data-formato="carta")
                                                                        i(class="fas fa-file-invoice")
                                                                    button(type="button" class="generar-factura-btn text-purple-500 hover:text-purple-700 text-lg cursor-pointer" title="Imprimir Ticket" data-actividad-id=actividad.id data-formato="ticket")
                                                                        i(class="fas fa-receipt")
                                                                if usuario && (usuario.role.nombre === 'Admin' || usuario.role.nombre === 'Supervisor') && actividad.estado !== 'Anulada'
                                                                    form.form-eliminar(method="POST", action=`/actividades/anular/${actividad.id}`)
                                                                        input(type="hidden" name="_csrf" value=csrfToken)
                                                                        button(type="submit" class="text-yellow-600 hover:text-yellow-800 text-lg cursor-pointer" title="Anular Actividad")
                                                                            i(class="fas fa-ban")

                                //- Tabla de Vales Responsiva
                                if ficha.vales.length
                                    h4(class="text-purple-800 font-bold text-lg mt-6 mb-2") Vales Registrados
                                    div(class="overflow-x-auto")
                                        table(class="w-full text-sm text-left")
                                            thead(class="hidden md:table-header-group bg-slate-100 text-slate-600 uppercase")
                                                tr
                                                    th(class="px-4 py-2") Descripción
                                                    th(class="px-4 py-2 text-right") Monto
                                                    th(class="px-4 py-2 text-center") Acciones
                                            tbody
                                                each vale in ficha.vales
                                                    tr(class="block md:table-row mb-4 md:mb-0 border md:border-none rounded-lg shadow-md md:shadow-none")
                                                        td(class="block md:table-cell p-3 text-right md:text-left border-b md:border-b-0")
                                                            span(class="md:hidden float-left font-bold") Descripción:
                                                            | #{vale.descripcion}
                                                        td(class="block md:table-cell p-3 text-right border-b md:border-b-0")
                                                            span(class="md:hidden float-left font-bold") Monto:
                                                            | $#{parseFloat(vale.vales).toLocaleString('es-CO')}
                                                        td(class="block md:table-cell p-3")
                                                            div(class="flex items-center justify-end md:justify-center")
                                                                - const hasPermission = usuario && usuario.role && (usuario.role.nombre === 'Admin' || usuario.role.nombre === 'Supervisor')
                                                                form.form-eliminar(method="POST", action=hasPermission ? `/actividades/eliminar/vale/${vale.id}` : '#')
                                                                    input(type="hidden" name="_csrf" value=csrfToken)
                                                                    button(type=hasPermission ? "submit" : "button" disabled=!hasPermission class=`text-lg ${hasPermission ? 'text-red-500 hover:text-red-700' : 'text-gray-400 cursor-not-allowed'}` title="Eliminar Vale")
                                                                        i(class="fas fa-trash")

                                //- Sección de Totales
                                div(class="bg-slate-50 p-4 border-t border-slate-200 space-y-2")
                                    div(class="flex justify-end items-baseline gap-4")
                                        span(class="font-semibold text-gray-600") Total Actividades:
                                        span(class="text-fuchsia-600 text-xl font-bold") $#{parseFloat(ficha.totalActividades).toLocaleString('es-CO')}
                                    if ficha.vales.length
                                        div(class="flex justify-end items-baseline gap-4")
                                            span(class="font-semibold text-gray-600") Total Vales:
                                            span(class="text-purple-600 text-lg font-bold") $#{parseFloat(ficha.totalVales).toLocaleString('es-CO')}

                //- Paginación
                if totalPaginas > 1
                    div(class="mt-8")
                        include ../layout/paginacion

                div#modalDetalles(class="fixed inset-0 bg-black bg-opacity-50 p-4 hidden")
                  div(class="bg-white rounded-lg shadow-xl max-w-lg w-full")
                      //- Encabezado de la Modal
                      //- CAMBIO: Se añade un padding extra (px-6) y se cambia el color del borde
                      div(class="flex justify-between items-center px-6 py-4 border-b border-fuchsia-200")
                          //- CAMBIO: Se añade text-center, flex-grow y se cambia el color del texto
                          h3(class="text-xl font-bold text-fuchsia-800 text-center flex-grow") Materiales Utilizados
                          //- CAMBIO: Se ajusta el color del hover
                          button#cerrarModal(class="text-gray-400 hover:text-fuchsia-600 text-3xl font-light cursor-pointer") &times;

                      //- Contenido de la Modal
                      div#modalContenido(class="p-6")
                          p(class="text-gray-600") Cargando detalles...

//- Mantenemos tu bloque de scripts intacto, solo ajustando colores
block scripts
  script(src="/js/modalDetalles.js")
  script(src="/js/facturaHandler.js")

  if query.guardado
    script.
      Swal.fire({
        icon: 'success',
        title: '¡Registro exitoso!',
        text: 'La Actividad fue registrado correctamente.', 
        confirmButtonColor: '#2563eb'
      });
      // Limpiar el parámetro de la URL sin recargar
      if (window.history.replaceState) {
        const url = new URL(window.location);
        url.searchParams.delete('guardado');
        window.history.replaceState({}, document.title, url.pathname);
      }

  if query.eliminado
    script.
      Swal.fire({
        icon: 'success',
        title: 'Anulado!',
        text: 'La actividad ha sido anulada correctamente.', 
        confirmButtonColor: '#2563eb'
      });
      if (window.history.replaceState) {
          const url = new URL(window.location);
          url.searchParams.delete('anulado');
          window.history.replaceState({}, document.title, url.pathname);
        }
  script.
    document.addEventListener('DOMContentLoaded', () => {
      const formulariosEliminar = document.querySelectorAll('.form-eliminar');

      formulariosEliminar.forEach(formulario => {
        formulario.addEventListener('submit', function (e) {
          e.preventDefault();

          Swal.fire({
            title: '¿Estás seguro?',
            text: 'Esta acción no se puede deshacer',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'Sí, eliminar',
            cancelButtonText: 'Cancelar'
          }).then((result) => {
            if (result.isConfirmed) {
              formulario.submit();
            }
          });
        });
      });
    });

  if query.error
    script.
      Swal.fire({
        icon: 'error',
        title: '¡Error!',
        text: 'Hubo un problema al registrar la actividad.',
        confirmButtonColor: '#dc2626'
      });
      // Limpiar el parámetro de la URL sin recargar
      if (window.history.replaceState) {
        const url = new URL(window.location);
        url.searchParams.delete('error');
        window.history.replaceState({}, document.title, url.pathname);
      }

  if query.eliminadoVale
    script.
      Swal.fire({
        icon: 'success',
        title: '¡Vale eliminado!',
        text: 'El vale ha sido eliminado correctamente.', 
        confirmButtonColor: '#2563eb'
      });
      if (window.history.replaceState) {
        const url = new URL(window.location);
        url.searchParams.delete('eliminadoVale');
        window.history.replaceState({}, document.title, url.pathname);
      }

  if query.errorVale
    script.
      Swal.fire({
        icon: 'error',
        title: '¡Error!',
        text: 'Hubo un problema al eliminar el vale.',
        confirmButtonColor: '#dc2626'
      });
      if (window.history.replaceState) {
        const url = new URL(window.location);
        url.searchParams.delete('errorVale');
        window.history.replaceState({}, document.title, url.pathname);
      }

  

